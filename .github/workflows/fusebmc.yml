name: FuSeBMC Analysis
on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v2
      with:
        fetch-depth: 0  

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v1

    - name: Login to GitHub Container Registry
      uses: docker/login-action@v2
      with:
        registry: ghcr.io
        username: ${{ github.repository_owner }}
        password: ${{ secrets.MY_GITHUB_PAT }}

    - name: Pull FuSeBMC Docker image
      run: docker pull ghcr.io/fusebmc/fusebmc-ai:build_system

    - name: Run privileged command
      run: |
        docker run --rm --privileged \
        -v /proc:/host/proc \
        --entrypoint /bin/sh \
        ghcr.io/fusebmc/fusebmc-ai:build_system \
        -c "echo core > /host/proc/sys/kernel/core_pattern"

    - name: Get changed files
      id: changed-files
      run: |
        if [ "${{ github.event_name }}" == "pull_request" ]; then
          git fetch origin ${{ github.base_ref }}
          changed_files=$(git diff --name-only --diff-filter=ACMRT origin/${{ github.base_ref }} ${{ github.sha }} | grep -E '\.c$|\.i$' || true)
        elif [ "${{ github.event_name }}" == "push" ]; then
          if git rev-parse --verify HEAD^1 >/dev/null 2>&1; then
            changed_files=$(git diff --name-only --diff-filter=ACMRT HEAD^1 HEAD | grep -E '\.c$|\.i$' || true)
          else
            changed_files=$(git ls-tree -r --name-only HEAD | grep -E '\.c$|\.i$' || true)
          fi
        else
          changed_files=$(git ls-tree -r --name-only HEAD | grep -E '\.c$|\.i$' || true)
        fi
        echo "::set-output name=files::$changed_files"

    - name: Run FuSeBMC on changed C files
      run: |
        if [ -z "${{ steps.changed-files.outputs.files }}" ]; then
          echo "No .c or .i files were changed."
          echo "## FuSeBMC Analysis Results" > results.md
          echo "No .c or .i files were changed." >> results.md
        else
          echo "## FuSeBMC Analysis Results" > results.md
          echo "### Summary" >> results.md
          echo "| File | Status |" >> results.md
          echo "|------|--------|" >> results.md
          for file in ${{ steps.changed-files.outputs.files }}; do
            if [ -f "$file" ]; then
              echo "Processing file: $file"
              output=$(docker run --rm \
                -v ${{ github.workspace }}:/workspace \
                ghcr.io/fusebmc/fusebmc-ai:build_system \
                --ai --verification -a 64 -s incr /workspace/$file)
              
              if echo "$output" | grep -q "VERIFICATION FAILED"; then
                echo "| $file | ❌ Failed |" >> results.md
                status="failed"
              elif echo "$output" | grep -q "VERIFICATION SUCCESSFUL"; then
                echo "| $file | ✅ Passed |" >> results.md
                status="passed"
              else
                echo "| $file | ⚠️ Unclear |" >> results.md
                status="unclear"
              fi
              
              echo "" >> results.md
              echo "### $file" >> results.md
              if [ "$status" = "failed" ]; then
                echo "#### Violated Properties:" >> results.md
                echo "$output" | sed -n '/Violated property:/,/VERIFICATION FAILED/p' >> results.md
              fi
              
              corrected_code=$(echo "$output" | sed -n '/FuSeBMC-AI: Here is the corrected code, verified with ESBMC:/,/```/p' | sed '1d;$d')
              if [ ! -z "$corrected_code" ]; then
                echo "#### Corrected Code (Verified by ESBMC)" >> results.md
                echo '```c' >> results.md
                echo "$corrected_code" >> results.md
                echo '```' >> results.md
                
                # Create a temporary file with corrected code
                echo "$corrected_code" > corrected_temp.c
                
                # Compare original and corrected files, add comments
                line_number=1
                while IFS= read -r original_line && IFS= read -r corrected_line <&3; do
                  if [ "$original_line" != "$corrected_line" ]; then
                    sed -i "${line_number}s|$|  // Corrected: $corrected_line|" "$file"
                  fi
                  ((line_number++))
                done < "$file" 3< corrected_temp.c
                
                # Remove temporary file
                rm corrected_temp.c
              fi
              echo "" >> results.md
            fi
          done
        fi

    - name: Create Pull Request
      uses: peter-evans/create-pull-request@v6
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: Apply FuSeBMC corrections as comments
        title: '[FuSeBMC] Apply automated corrections as comments'
        body: |
          This pull request adds FuSeBMC suggested corrections as comments next to the original code lines.
          
          Please review the changes carefully before merging. You may want to apply these comments manually to fix the issues.
        branch: fusebmc-corrections-comments
        delete-branch: true
        base: ${{ github.ref }}

    - name: Check for failures
      run: |
        if grep -q "VERIFICATION FAILED" results.md; then
          exit 1
        fi

    - name: Upload results
      if: always()
      uses: actions/upload-artifact@v2
      with:
        name: fusebmc-results
        path: results.md
